#lang racket

(define cols 12)
(define rows 4)

(define x-offset 20)
(define y-offset 20)

(define spacing 19)
(define angle 10)

(define column-offsets '(8 5 0 6 11 59 59 11 6 0 5 8))

(define (switch-module x y rotation label net-pos net-neg)
  ;; TODO: set timestamps?
  `(module Keebio-Parts:MX-Alps-Choc-1U-NoLED (layer Front) (tedit 4FD81CDD) (tstamp 543EF801)
     (at ,x ,y ,rotation)
     (path /543DB910) ; TODO: this is not documented; no idea what it does
     (fp_text reference ,label (at 0 3.302 ,rotation) (layer F.SilkS)
              (effects (font (size 1.524 1.778) (thickness 0.254))))
     (fp_line (start -9.525 9.525) (end -9.525 -9.525) (layer Dwgs.User) (width 0.15))
     (fp_line (start 9.525 9.525) (end -9.525 9.525) (layer Dwgs.User) (width 0.15))
     (fp_line (start 9.525 -9.525) (end 9.525 9.525) (layer Dwgs.User) (width 0.15))
     (fp_line (start -9.525 -9.525) (end 9.525 -9.525) (layer Dwgs.User) (width 0.15))
     (fp_line (start -7 -7) (end -7 -5) (layer Dwgs.User) (width 0.15))
     (fp_line (start -5 -7) (end -7 -7) (layer Dwgs.User) (width 0.15))
     (fp_line (start -7 7) (end -5 7) (layer Dwgs.User) (width 0.15))
     (fp_line (start -7 5) (end -7 7) (layer Dwgs.User) (width 0.15))
     (fp_line (start 7 7) (end 7 5) (layer Dwgs.User) (width 0.15))
     (fp_line (start 5 7) (end 7 7) (layer Dwgs.User) (width 0.15))
     (fp_line (start 7 -7) (end 7 -5) (layer Dwgs.User) (width 0.15))
     (fp_line (start 5 -7) (end 7 -7) (layer Dwgs.User) (width 0.15))

     (pad "" np_thru_hole circle (at -5.22 4.2 ,(+ 48.1 rotation)) (size 1.2 1.2) (drill 1.2) (layers *.Cu *.Mask))
     (pad "" np_thru_hole circle (at -5.08 0 ,(+ 48.1 rotation)) (size 1.75 1.75) (drill 1.75) (layers *.Cu *.Mask))
     (pad "" np_thru_hole circle (at -5.5 0 ,(+ 48.1 rotation)) (size 1.7 1.7) (drill 1.7) (layers *.Cu *.Mask))
     (pad "" np_thru_hole circle (at 0 0 ,rotation) (size 3.9878 3.9878) (drill 3.9878) (layers *.Cu *.Mask))
     (pad "" np_thru_hole circle (at 5.08 0 ,(+ 48.1 rotation)) (size 1.75 1.75) (drill 1.75) (layers *.Cu *.Mask))
     (pad "" np_thru_hole circle (at 5.5 0 ,(+ 48.1 rotation)) (size 1.7 1.7) (drill 1.7) (layers *.Cu *.Mask))

     (pad 1 thru_hole circle (at 2.54 -5.08 ,rotation) (size 2.25 2.25) (drill 1.47) (layers *.Cu *.Mask) ,net-pos)
     (pad 1 thru_hole circle (at 5 -3.8 ,rotation) (size 2 2) (drill 1.2) (layers *.Cu *.Mask) ,net-pos)
     (pad 1 thru_hole oval (at 2.5 -4.5 96.1) (size 2.831378 2.25) (drill 1.47 (offset 0.290689 0)) (layers *.Cu *.Mask) ,net-pos)

     (pad 2 thru_hole circle (at -2.5 -4 ,rotation) (size 2.25 2.25) (drill 1.47) (layers *.Cu *.Mask) ,net-neg)
     (pad 2 thru_hole circle (at 0 -5.9 ,rotation) (size 2 2) (drill 1.2) (layers *.Cu *.Mask) ,net-neg)
     (pad 2 thru_hole oval (at -3.81 -2.54 ,(+ 48.1 rotation)) (size 4.211556 2.25) (drill 1.47 (offset 0.980778 0)) (layers *.Cu *.Mask) ,net-neg)))

(define (crystal-module x y rotation label net-a net-b net-gnd)
  `(module Crystals:Crystal_SMD_3225-4pin_3.2x2.5mm (layer B.Cu) (tedit 58CD2E9C) (tstamp 5CF3B611)
     (at ,x ,y ,rotation)
     (descr "SMD Crystal SERIES SMD3225/4 http://www.txccrystal.com/images/pdf/7m-accuracy.pdf, 3.2x2.5mm^2 package")
     (tags "SMD SMT crystal")
     (path /5CEBCEA8)
     (attr smd)
     (fp_text reference Y1 (at 0 2.45 180) (layer B.SilkS)
              (effects (font (size 1 1) (thickness 0.15)) (justify mirror))
              )
     (fp_text value Crystal_GND24_Small (at 0 -2.45 180) (layer B.Fab)
              (effects (font (size 1 1) (thickness 0.15)) (justify mirror))
              )
     (fp_line (start -1.6 1.25) (end -1.6 -1.25) (layer B.Fab) (width 0.1))
     (fp_line (start -1.6 -1.25) (end 1.6 -1.25) (layer B.Fab) (width 0.1))
     (fp_line (start 1.6 -1.25) (end 1.6 1.25) (layer B.Fab) (width 0.1))
     (fp_line (start 1.6 1.25) (end -1.6 1.25) (layer B.Fab) (width 0.1))
     (fp_line (start -1.6 -0.25) (end -0.6 -1.25) (layer B.Fab) (width 0.1))
     (fp_line (start -2 1.65) (end -2 -1.65) (layer B.SilkS) (width 0.12))
     (fp_line (start -2 -1.65) (end 2 -1.65) (layer B.SilkS) (width 0.12))
     (fp_line (start -2.1 1.7) (end -2.1 -1.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start -2.1 -1.7) (end 2.1 -1.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start 2.1 -1.7) (end 2.1 1.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start 2.1 1.7) (end -2.1 1.7) (layer B.CrtYd) (width 0.05))
     (pad 1 smd rect (at -1.1 -0.85 180) (size 1.4 1.2) (layers B.Cu B.Paste B.Mask) ,net-a)
     (pad 2 smd rect (at 1.1 -0.85 180) (size 1.4 1.2) (layers B.Cu B.Paste B.Mask) ,net-gnd)
     (pad 3 smd rect (at 1.1 0.85 180) (size 1.4 1.2) (layers B.Cu B.Paste B.Mask) ,net-b)
     (pad 4 smd rect (at -1.1 0.85 180) (size 1.4 1.2) (layers B.Cu B.Paste B.Mask) ,net-gnd)))


(define (diode-module x y rotation label net-pos net-neg)
  `(module DIODE (layer Front) (tedit 4E0F7A99) (tstamp 543EF854)
     (at ,x ,y ,(+ 90 rotation))
     (path /543DB90F)
     (attr smd)
     (fp_text reference D2:2 (at 0 0 180) (layer F.SilkS) hide
              (effects (font (size 1.016 1.016) (thickness 0.2032)))
              )
     (fp_text value "" (at 0 0 80) (layer F.SilkS)
              (effects (font (size 1.27 1.27) (thickness 0.15)))
              )
     (fp_line (start -2.54 0.762) (end 2.54 0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.54 0.762) (end 2.54 -0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.54 -0.762) (end -2.54 -0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start -2.54 -0.762) (end -2.54 0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start -2.54 0.762) (end -2.032 0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.159 0.762) (end 2.159 -0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.286 -0.762) (end 2.286 0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.413 0.762) (end 2.413 -0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 2.032 -0.762) (end 2.032 0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 1.905 0.762) (end 1.905 -0.762) (layer F.SilkS) (width 0.15))
     (fp_line (start 1.778 0.762) (end 1.778 -0.762) (layer F.SilkS) (width 0.15))
     (pad 1 smd rect (at 1.4 0 ,(+ 90 rotation)) (size 1.6 1.2) (layers Back B.Paste B.Mask) ,net-pos)
     (pad 1 smd rect (at 1.4 0 ,(+ 90 rotation)) (size 1.6 1.2) (layers Front F.Paste F.Mask) ,net-pos)
     (pad 1 smd rect (at 2.5 0 ,(+ 90 rotation)) (size 2.9 0.5) (layers Back) ,net-pos)
     (pad 1 smd rect (at 2.5 0 ,(+ 90 rotation)) (size 2.9 0.5) (layers Front) ,net-pos)
     (pad 2 smd rect (at -1.4 0 ,(+ 90 rotation)) (size 1.6 1.2) (layers Back B.Paste B.Mask) ,net-neg)
     (pad 2 smd rect (at -1.4 0 ,(+ 90 rotation)) (size 1.6 1.2) (layers Front F.Paste F.Mask) ,net-neg)
     (pad 2 smd rect (at -2.5 0 ,(+ 90 rotation)) (size 2.9 0.5) (layers Back) ,net-neg)
     (pad 2 smd rect (at -2.5 0 ,(+ 90 rotation)) (size 2.9 0.5) (layers Front) ,net-neg)

     (pad 1 thru_hole rect (at 3.9 0 ,(+ 90 rotation)) (size 1.6 1.6) (drill 1) (layers *.Cu *.Mask F.SilkS) ,net-pos)
     (pad 2 thru_hole circle (at -3.9 0 ,(+ 90 rotation)) (size 1.6 1.6) (drill 1) (layers *.Cu *.Mask F.SilkS) ,net-neg)))

(define atmega-module
  `(module ATMEGA32U4-AU (layer F.Cu) (tedit 0)
     (at 133.5 80 0)
     (solder_mask_margin 0.1)
     (attr smd)
     (descr "44-Lead Plastic Thin Quad Flatpack (PT) - 10x10x1.0 mm Body [TQFP] (see Microchip Packaging Specification 00000049BS.pdf)")
     (tags "QFP 0.8")
     (path /5CEB8A23)
     (attr smd)
     (fp_text reference U1 (at 0 7.45) (layer B.SilkS) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_text value ATmega32U4-AU (at 0 -7.45) (layer B.Fab) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_text user %R (at 0 0) (layer B.Fab) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_line (start -4 5) (end 5 5) (layer B.Fab) (width 0.15))
     (fp_line (start 5 5) (end 5 -5) (layer B.Fab) (width 0.15))
     (fp_line (start 5 -5) (end -5 -5) (layer B.Fab) (width 0.15))
     (fp_line (start -5 -5) (end -5 4) (layer B.Fab) (width 0.15))
     (fp_line (start -5 4) (end -4 5) (layer B.Fab) (width 0.15))
     (fp_line (start -6.7 6.7) (end -6.7 -6.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start 6.7 6.7) (end 6.7 -6.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start -6.7 6.7) (end 6.7 6.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start -6.7 -6.7) (end 6.7 -6.7) (layer B.CrtYd) (width 0.05))
     (fp_line (start -5.175 5.175) (end -5.175 4.6) (layer B.SilkS) (width 0.15))
     (fp_line (start 5.175 5.175) (end 5.175 4.5) (layer B.SilkS) (width 0.15))
     (fp_line (start 5.175 -5.175) (end 5.175 -4.5) (layer B.SilkS) (width 0.15))
     (fp_line (start -5.175 -5.175) (end -5.175 -4.5) (layer B.SilkS) (width 0.15))
     (fp_line (start -5.175 5.175) (end -4.5 5.175) (layer B.SilkS) (width 0.15))
     (fp_line (start -5.175 -5.175) (end -4.5 -5.175) (layer B.SilkS) (width 0.15))
     (fp_line (start 5.175 -5.175) (end 4.5 -5.175) (layer B.SilkS) (width 0.15))
     (fp_line (start 5.175 5.175) (end 4.5 5.175) (layer B.SilkS) (width 0.15))
     (fp_line (start -5.175 4.6) (end -6.45 4.6) (layer B.SilkS) (width 0.15))
     (pad 1 smd rect (at -5.7 4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 101 Net-U1-Pad1))
     (pad 2 smd rect (at -5.7 3.2) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))
     (pad 3 smd rect (at -5.7 2.4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 103 Net-R3-Pad1))
     (pad 4 smd rect (at -5.7 1.6) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 104 Net-R2-Pad1))
     (pad 5 smd rect (at -5.7 0.8) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 105 GND))
     (pad 6 smd rect (at -5.7 0) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 106 Net-C3-Pad1))
     (pad 7 smd rect (at -5.7 -0.8) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))
     (pad 8 smd rect (at -5.7 -1.6) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 108 Net-U1-Pad8))
     (pad 9 smd rect (at -5.7 -2.4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 109 Net-U1-Pad9))
     (pad 10 smd rect (at -5.7 -3.2) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 110 Net-U1-Pad10))
     (pad 11 smd rect (at -5.7 -4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 111 Net-U1-Pad11))
     (pad 12 smd rect (at -4 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 112 Net-U1-Pad12))
     (pad 13 smd rect (at -3.2 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 113 Net-R1-Pad2))
     (pad 14 smd rect (at -2.4 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))
     (pad 15 smd rect (at -1.6 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 105 GND))
     (pad 16 smd rect (at -0.8 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 116 Net-C2-Pad1))
     (pad 17 smd rect (at 0 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 117 Net-C1-Pad1))
     (pad 18 smd rect (at 0.8 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 118 Net-U1-Pad18))
     (pad 19 smd rect (at 1.6 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 119 Net-U1-Pad19))
     (pad 20 smd rect (at 2.4 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 120 Net-U1-Pad20))
     (pad 21 smd rect (at 3.2 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 121 Net-U1-Pad21))
     (pad 22 smd rect (at 4 -5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 122 Net-U1-Pad22))
     (pad 23 smd rect (at 5.7 -4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 105 GND))
     (pad 24 smd rect (at 5.7 -3.2) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))
     (pad 25 smd rect (at 5.7 -2.4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 125 Net-U1-Pad25))
     (pad 26 smd rect (at 5.7 -1.6) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 126 Net-U1-Pad26))
     (pad 27 smd rect (at 5.7 -0.8) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask))
     (pad 28 smd rect (at 5.7 0) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask))
     (pad 29 smd rect (at 5.7 0.8) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask))
     (pad 30 smd rect (at 5.7 1.6) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask))
     (pad 31 smd rect (at 5.7 2.4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 131 Net-U1-Pad31))
     (pad 32 smd rect (at 5.7 3.2) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 132 Net-U1-Pad32))
     (pad 33 smd rect (at 5.7 4) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 133 Net-R4-Pad2))
     (pad 34 smd rect (at 4 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))
     (pad 35 smd rect (at 3.2 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 105 GND))
     (pad 36 smd rect (at 2.4 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 136 Net-U1-Pad36))
     (pad 37 smd rect (at 1.6 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 137 Net-U1-Pad37))
     (pad 38 smd rect (at 0.8 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 138 Net-U1-Pad38))
     (pad 39 smd rect (at 0 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 139 Net-U1-Pad39))
     (pad 40 smd rect (at -0.8 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 140 Net-U1-Pad40))
     (pad 41 smd rect (at -1.6 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 141 Net-U1-Pad41))
     (pad 42 smd rect (at -2.4 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 142 Net-U1-Pad42))
     (pad 43 smd rect (at -3.2 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 105 GND))
     (pad 44 smd rect (at -4 5.7 270) (size 1.5 0.55) (layers B.Cu B.Paste B.Mask) (net 102 +5V))))

(define (capacitor-module x y rotation cvalue net-pos net-neg)
  `(module Capacitors_SMD:C_0805 (layer B.Cu) (tedit 58AA8463) (tstamp 5C346F4D)
     (at ,x ,y ,rotation)
     (descr "Capacitor SMD 0805, reflow soldering, AVX (see smccp.pdf)")
     (tags "capacitor 0805")
     (path /5C341D22)
     (attr smd)
     (fp_text reference C1 (at 0 1.5 90) (layer B.SilkS) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_text value 22pF (at 0 -1.75 90) (layer B.Fab) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_line (start -1 -0.62) (end -1 0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 1 -0.62) (end -1 -0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 1 0.62) (end 1 -0.62) (layer B.Fab) (width 0.1))
     (fp_line (start -1 0.62) (end 1 0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 0.5 0.85) (end -0.5 0.85) (layer B.SilkS) (width 0.12))
     (fp_line (start -0.5 -0.85) (end 0.5 -0.85) (layer B.SilkS) (width 0.12))
     (fp_line (start -1.75 0.88) (end 1.75 0.88) (layer B.CrtYd) (width 0.05))
     (fp_line (start -1.75 0.88) (end -1.75 -0.87) (layer B.CrtYd) (width 0.05))
     (fp_line (start 1.75 -0.87) (end 1.75 0.88) (layer B.CrtYd) (width 0.05))
     (fp_line (start 1.75 -0.87) (end -1.75 -0.87) (layer B.CrtYd) (width 0.05))
     (pad 1 smd rect (at -1 0 90) (size 1 1.25) (layers B.Cu B.Paste B.Mask) ,net-neg)
     (pad 2 smd rect (at 1 0 90) (size 1 1.25) (layers B.Cu B.Paste B.Mask) ,net-pos)
     )
  )

(define (resistor-module x y rotation label rvalue net-pos net-neg)
  `(module Resistors_SMD:R_0805 (layer B.Cu) (tedit 58E0A804) (tstamp 5C3454AB)
     (at ,x ,y ,rotation)
     (descr "Resistor SMD 0805, reflow soldering, Vishay (see dcrcw.pdf)")
     (tags "resistor 0805")
     (path /5C33F6F4)
     (attr smd)
     (fp_text reference ,label (at 0 1.65 90) (layer B.SilkS) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_text value ,rvalue (at 0 -1.75 90) (layer B.Fab) (effects (font (size 1 1) (thickness 0.15)) (justify mirror)))
     (fp_line (start -1 -0.62) (end -1 0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 1 -0.62) (end -1 -0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 1 0.62) (end 1 -0.62) (layer B.Fab) (width 0.1))
     (fp_line (start -1 0.62) (end 1 0.62) (layer B.Fab) (width 0.1))
     (fp_line (start 0.6 -0.88) (end -0.6 -0.88) (layer B.SilkS) (width 0.12))
     (fp_line (start -0.6 0.88) (end 0.6 0.88) (layer B.SilkS) (width 0.12))
     (fp_line (start -1.55 0.9) (end 1.55 0.9) (layer B.CrtYd) (width 0.05))
     (fp_line (start -1.55 0.9) (end -1.55 -0.9) (layer B.CrtYd) (width 0.05))
     (fp_line (start 1.55 -0.9) (end 1.55 0.9) (layer B.CrtYd) (width 0.05))
     (fp_line (start 1.55 -0.9) (end -1.55 -0.9) (layer B.CrtYd) (width 0.05))
     (pad 1 smd rect (at -0.95 0 90) (size 0.7 1.3) (layers B.Cu B.Paste B.Mask) ,net-pos)
     (pad 2 smd rect (at 0.95 0 90) (size 0.7 1.3) (layers B.Cu B.Paste B.Mask) ,net-neg)))

(define usb-mini-module
  `(module Molex-0548190589 (layer F.Cu) (tedit 5C494815)
     (at 134 54 -90)
     (attr smd)
     (fp_text reference REF** (at 2.032 0 90) (layer F.SilkS) (effects (font (size 1 1) (thickness 0.15))))
     (fp_text value Molex-0548190589 (at -5.08 0 90) (layer Dwgs.User) (effects (font (size 1 1) (thickness 0.15))))
     (fp_line (start -3.75 -3.85) (end -3.75 3.85) (layer Dwgs.User) (width 0.15))
     (fp_line (start -1.75 -4.572) (end -1.75 4.572) (layer Dwgs.User) (width 0.15))
     (fp_line (start -3.75 3.85) (end 0 3.85) (layer Dwgs.User) (width 0.15))
     (fp_line (start -3.75 -3.85) (end 0 -3.85) (layer Dwgs.User) (width 0.15))
     (fp_line (start 5.45 -3.85) (end 5.45 3.85) (layer F.SilkS) (width 0.15))
     (fp_line (start 0 3.85) (end 5.45 3.85) (layer F.SilkS) (width 0.15))
     (fp_line (start 0 -3.85) (end 5.45 -3.85) (layer F.SilkS) (width 0.15))
     (fp_line (start -3.75 -3.75) (end 5.5 -3.75) (layer F.CrtYd) (width 0.15))
     (fp_line (start 5.5 -3.75) (end 5.5 3.75) (layer F.CrtYd) (width 0.15))
     (fp_line (start 5.5 3.75) (end -3.75 3.75) (layer F.CrtYd) (width 0.15))
     (fp_line (start -3.75 3.75) (end -3.75 -3.75) (layer F.CrtYd) (width 0.15))
     (fp_line (start 5.5 -2) (end 3.25 -2) (layer F.CrtYd) (width 0.15))
     (fp_line (start 3.25 -2) (end 3.25 2) (layer F.CrtYd) (width 0.15))
     (fp_line (start 3.25 2) (end 5.5 2) (layer F.CrtYd) (width 0.15))
     (fp_line (start 5.5 1.25) (end 3.25 1.25) (layer F.CrtYd) (width 0.15))
     (fp_line (start 3.25 0.5) (end 5.5 0.5) (layer F.CrtYd) (width 0.15))
     (fp_line (start 5.5 -0.5) (end 3.25 -0.5) (layer F.CrtYd) (width 0.15))
     (fp_line (start 3.25 -1.25) (end 5.5 -1.25) (layer F.CrtYd) (width 0.15))
     (pad 1 smd rect (at 4.5 1.6) (size 2.25 0.5) (layers F.Cu F.Paste F.Mask))
     (pad 2 smd rect (at 4.5 0.8) (size 2.25 0.5) (layers F.Cu F.Paste F.Mask))
     (pad 3 smd rect (at 4.5 0) (size 2.25 0.5) (layers F.Cu F.Paste F.Mask))
     (pad 4 smd rect (at 4.5 -0.8) (size 2.25 0.5) (layers F.Cu F.Paste F.Mask))
     (pad 5 smd rect (at 4.5 -1.6) (size 2.25 0.5) (layers F.Cu F.Paste F.Mask))
     (pad 6 thru_hole oval (at 4.5 -3.65) (size 2.7 1.7) (drill oval 1.9 0.7) (layers *.Cu *.Mask))
     (pad 6 thru_hole oval (at 4.5 3.65) (size 2.7 1.7) (drill oval 1.9 0.7) (layers *.Cu *.Mask))
     (pad 6 thru_hole oval (at 0 3.65) (size 2.7 1.7) (drill oval 1.9 0.7) (layers *.Cu *.Mask))
     (pad 6 thru_hole oval (at 0 -3.65) (size 2.7 1.7) (drill oval 1.9 0.7) (layers *.Cu *.Mask))))

(define microcontroller-module
  `(module PROMICRO (layer Front) (tedit 4FDC31C8) (tstamp 543EF800)
     (at 134 70 270)
     (path /543EEB02)
     (fp_text value 32U4 (at -3 0 270) (layer F.SilkS)
              (effects (font (size 3.048 2.54) (thickness 0.4572))))
     (fp_line (start -15.24 7.62) (end 15.9 7.62) (layer F.SilkS) (width 0.381))
     (fp_line (start 15.9 7.62) (end 15.9 -7.62) (layer F.SilkS) (width 0.381))
     (fp_line (start 15.9 -7.62) (end -15.24 -7.62) (layer F.SilkS) (width 0.381))
     (pad B6 thru_hole circle (at 13.97 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 4 N-row-3))
     (pad B2 thru_hole circle (at 11.43 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 3 N-row-2))
     (pad B3 thru_hole circle (at 8.89 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 14 N-col-9))
     (pad B1 thru_hole circle (at 6.35 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 15 N-col-10))
     (pad F7 thru_hole circle (at 3.81 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 11 N-col-6))
     (pad F6 thru_hole circle (at 1.27 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 12 N-col-7))
     (pad F5 thru_hole circle (at -1.27 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 13 N-col-8))
     (pad F4 thru_hole circle (at -3.81 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad VCC thru_hole circle (at -6.35 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad RST thru_hole circle (at -8.89 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad GND thru_hole circle (at -11.43 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad RAW thru_hole circle (at -13.97 -6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad B5 thru_hole circle (at 13.97 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 2 N-row-1))
     (pad B4 thru_hole circle (at 11.43 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 1 N-row-0))
     (pad E6 thru_hole circle (at 8.89 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 10 N-col-5))
     (pad D7 thru_hole circle (at 6.35 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 6 N-col-1))
     (pad C6 thru_hole circle (at 3.81 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 5 N-col-0))
     (pad D4 thru_hole circle (at 1.27 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 9 N-col-4))
     (pad D0 thru_hole circle (at -1.27 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 8 N-col-3))
     (pad D1 thru_hole circle (at -3.81 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask) (net 7 N-col-2))
     (pad GND thru_hole circle (at -6.35 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad GND thru_hole circle (at -8.89 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad RX1 thru_hole circle (at -11.43 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))
     (pad TX0 thru_hole rect (at -13.97 6.35 270) (size 1.7526 1.7526) (drill 1.0922) (layers *.Cu *.SilkS *.Mask))))

(define nets
  `((net 0 "")
    (net 1 N-row-0)
    (net 2 N-row-1)
    (net 3 N-row-2)
    (net 4 N-row-3)
    (net 5  N-col-0)
    (net 6  N-col-1)
    (net 7  N-col-2)
    (net 8  N-col-3)
    (net 9  N-col-4)
    (net 10 N-col-5)
    (net 11 N-col-6)
    (net 12 N-col-7)
    (net 13 N-col-8)
    (net 14 N-col-9)
    (net 15 N-col-10)
    ,@(for/list ([s (in-range 42)])
        (list 'net (+ 16 s) (string->symbol (format "N-diode-~s" s))))
    (net 117 Net-C1-Pad1)
    (net 105 GND)
    (net 116 Net-C2-Pad1)
    (net 106 Net-C3-Pad1)
    (net 102 +5V)
    (net 63 VCC)
    (net 113 Net-R1-Pad2)
    (net 104 Net-R2-Pad1)
    (net 68 D+)
    (net 67 D-)
    (net 103 Net-R3-Pad1)
    (net 133 Net-R4-Pad2)
    (net 142 Net-U1-Pad42)
    (net 141 Net-U1-Pad41)
    (net 140 Net-U1-Pad40)
    (net 139 Net-U1-Pad39)
    (net 138 Net-U1-Pad38)
    (net 137 Net-U1-Pad37)
    (net 136 Net-U1-Pad36)
    (net 132 Net-U1-Pad32)
    (net 131 Net-U1-Pad31)
    (net 126 Net-U1-Pad26)
    (net 125 Net-U1-Pad25)
    (net 122 Net-U1-Pad22)
    (net 121 Net-U1-Pad21)
    (net 120 Net-U1-Pad20)
    (net 119 Net-U1-Pad19)
    (net 118 Net-U1-Pad18)
    (net 112 Net-U1-Pad12)
    (net 111 Net-U1-Pad11)
    (net 110 Net-U1-Pad10)
    (net 109 Net-U1-Pad9)
    (net 108 Net-U1-Pad8)
    (net 101 Net-U1-Pad1)
    (net 94 Net-USB1-Pad2)))

(define (net-class nets)
  (append '(net_class Default "This is the default net class."
                      (clearance 0.254)
                      (trace_width 0.2032)
                      (via_dia 0.889)
                      (via_drill 0.635)
                      (uvia_dia 0.508)
                      (uvia_drill 0.127))
          (for/list ([n nets])
            (list 'add_net (last n)))))

(define (switch row col)
  (let* ([left? (< col 6)]
         [rotation (if left? -10 10)]
         [x (* (+ 1 col) spacing)]
         [y (+ (list-ref column-offsets col) (* spacing row))]
         [hypotenuse (sqrt (+ (* x x) (* y y)))]
         [Θ (atan (/ y x))]
         [Θ′ (- Θ (degrees->radians rotation))]
         [x′ (+ (if left? x-offset 5) (* hypotenuse (cos Θ′)))]
         [y′ (+ (if left? y-offset (+ y-offset 42.885)) (* hypotenuse (sin Θ′)))]
         [label (format "SW~a:~a" col row)]
         [diode (+ row (* col 4))]
         ;; if we try to number nets linearly, kicad segfaults; woo!
         ;; so we re-use the nets we skipped with the missing col 5/6 diodes
         [diode (cond [(> diode 44) (- diode 20)]
                      [(> diode 41) (- diode 21)]
                      [true diode])]
         [net-col (if left? col (- col 1))]
         [diode-net `(net ,(+ 16 diode)
                          ,(string->symbol (format "N-diode-~s" diode)))]
         [column-net `(net ,(+ net-col 5)
                           ,(string->symbol (format "N-col-~s" net-col)))]
         ;; rotate middle keys additional 90° after calculating position
         [rotation (cond [(= 5 col) 80]
                         [(= 6 col) 280]
                         [true rotation])])
    (switch-module x′ y′ rotation label
                   (if left? diode-net column-net)
                   (if left? column-net diode-net))))

(define (diode row col)
  (let* ([left? (< col 6)]
         [rotation (if left? -10 10)]
         [x (* (+ 1 col) spacing)]
         [y (+ (list-ref column-offsets col) (* spacing row))]
         [hypotenuse (sqrt (+ (* x x) (* y y)))]
         [Θ (atan (/ y x))]
         [Θ′ (- Θ (degrees->radians rotation))]
         [x′ (+ (if left? x-offset 5) (* hypotenuse (cos Θ′))
                (if left? 9 -9))]
         [y′ (+ (if left? y-offset (+ y-offset 42.885))
                (* hypotenuse (sin Θ′)))]
         [label (format "D~a:~a" col row)]
         [diode (+ row (* col 4))]
         ;; if we try to number nets linearly, kicad segfaults; woo!
         ;; so we re-use the nets we skipped with the missing col 5/6 diodes
         [diode (cond [(> diode 44) (- diode 20)]
                      [(> diode 41) (- diode 21)]
                      [true diode])]
         [net-row (cond [(= col 5) 2]
                        [(= col 6) 3]
                        [true row])])
    (diode-module x′ y′ rotation label
                  `(net ,(+ 16 diode)
                        ,(string->symbol (format "N-diode-~s" diode)))
                  `(net ,(+ net-row 1)
                        ,(string->symbol (format "N-row-~s" net-row))))))

(define switches+diodes
  (for/list ([col (in-range cols)]
             #:when true
             [row (if (or (= 5 col) (= 6 col))
                      '(0) (in-range rows))])
    (list (switch row col) (diode row col))))

(define edge-cuts
  (for/list [(s '([31 22] [84 22]  [141 30] [127 30] [127 52] [141 30] [185 22] [237 22] [250 95]  [161 112] [107 112] [18 95]))
             (e '([84 22] [127 30] [185 22] [127 52] [141 52] [141 52] [237 22] [250 95] [161 112] [107 112] [18 95]   [31 22]))]
    `(gr_line (start ,@s) (end ,@e) (angle 90) (layer Edge.Cuts) (width 0.3))))

(define board
  (apply append nets
         (list (net-class nets))
         ;(list microcontroller-module)
         (list atmega-module)
         (list usb-mini-module)
         (list (resistor-module 10 10 0 "R22" 22 `(net 105 GND) `(net 117 Net-C1-Pad1)))
         edge-cuts
         switches+diodes))

(define (write-placement filename)
  (when (file-exists? filename) (delete-file filename))
  (call-with-output-file filename
    (λ (op)
      (display (call-with-input-file "header-promicro.rktd"
                 (curry read-string 9999)) op)
      ;; kicad has this terrible bug where it's whitespace-sensitive here =(
      (display "\n" op)
      (for ([f board])
        (pretty-print f op 1))
      (display (call-with-input-file "traces-promicro.rktd"
                 (curry read-string 999999)) op)
      (display ")" op))))

(write-placement "atreus.kicad_pcb")
